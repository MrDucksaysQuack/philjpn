generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   String            @id @default(uuid())
  email                String            @unique
  password             String
  name                 String
  role                 UserRole          @default(user)
  phone                String?
  profileImage         String?           @db.VarChar(500)
  isActive             Boolean           @default(true)
  isEmailVerified      Boolean           @default(false)
  lastLoginAt          DateTime?
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt
  deletedAt            DateTime?
  auditLogs            AuditLog[]
  examResults          ExamResult[]
  createdExamTemplates ExamTemplate[]
  createdExams         Exam[]
  keyUsageLogs         KeyUsageLog[]
  learningCycles       LearningCycle[]
  learningPatterns     LearningPattern[]
  issuedLicenseKeys    LicenseKey[]      @relation("IssuedBy")
  licenseKeys          LicenseKey[]
  issuedLicenseKeyBatches LicenseKeyBatch[] @relation("BatchIssuer")
  createdQuestionPools QuestionPool[]
  updatedSiteSettings  SiteSettings[]    @relation("SiteSettingsUpdater")
  examSessions         UserExamSession[]
  goals                UserGoal[]
  wordBooks            WordBook[]

  @@index([email])
  @@index([role])
  @@index([createdAt])
  @@map("users")
}

model Exam {
  id             String            @id @default(uuid())
  title          String
  description    String?
  examType       ExamType
  subject        String?           @db.VarChar(100)
  difficulty     Difficulty?
  totalQuestions Int               @default(0)
  totalSections  Int               @default(0)
  estimatedTime  Int?
  passingScore   Int?
  isActive       Boolean           @default(true)
  isPublic       Boolean           @default(false)
  publishedAt    DateTime?
  createdBy      String?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  deletedAt      DateTime?
  templateId     String?
  randomSeed     Int?
  isAdaptive     Boolean           @default(false)
  adaptiveConfig Json?
  config         ExamConfig?
  // Category/Subcategory 연결
  categoryId     String?
  subcategoryId  String?
  category       Category?         @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  subcategory    Subcategory?      @relation(fields: [subcategoryId], references: [id], onDelete: SetNull)
  examResults    ExamResult[]
  creator        User?             @relation(fields: [createdBy], references: [id])
  template       ExamTemplate?     @relation("TemplateBased", fields: [templateId], references: [id])
  sections       Section[]
  examSessions   UserExamSession[]
  adaptiveQuestions AdaptiveQuestion[]

  @@index([examType])
  @@index([subject])
  @@index([isActive])
  @@index([createdAt])
  @@index([templateId])
  @@index([isAdaptive])
  @@index([categoryId])
  @@index([subcategoryId])
  @@map("exams")
}

model ExamConfig {
  id                     String   @id @default(uuid())
  examId                 String   @unique
  allowSectionNavigation Boolean  @default(true)
  allowQuestionReview    Boolean  @default(true)
  showAnswerAfterSubmit  Boolean  @default(true)
  showScoreImmediately   Boolean  @default(true)
  timeLimitPerSection    Boolean  @default(false)
  shuffleQuestions       Boolean  @default(false)
  shuffleOptions         Boolean  @default(false)
  preventTabSwitch       Boolean  @default(false)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
  exam                   Exam     @relation(fields: [examId], references: [id], onDelete: Cascade)

  @@map("exam_configs")
}

model Section {
  id             String          @id @default(uuid())
  examId         String
  title          String
  description    String?
  order          Int
  questionCount  Int             @default(0)
  timeLimit      Int?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  questions      Question[]
  sectionResults SectionResult[]
  exam           Exam            @relation(fields: [examId], references: [id], onDelete: Cascade)

  @@index([examId])
  @@index([examId, order])
  @@map("sections")
}

model Question {
  id              String           @id @default(uuid())
  sectionId       String
  questionBankId  String?
  questionNumber  Int
  questionType    QuestionType
  content         String
  options         Json?
  correctAnswer   String
  explanation     String?
  points          Int              @default(1)
  difficulty      Difficulty?
  tags            String[]
  imageUrl        String?          // 문제 이미지 URL (Part 1: Vocabulary & Grammar용)
  audioUrl        String?          // 오디오 파일 URL (Part 4: Listening용)
  audioPlayLimit  Int?             @default(2) // 오디오 재생 횟수 제한 (기본 2회)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  questionResults QuestionResult[]
  questionBank    QuestionBank?      @relation(fields: [questionBankId], references: [id])
  section         Section            @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  adaptiveQuestions AdaptiveQuestion[]

  @@index([sectionId])
  @@index([sectionId, questionNumber])
  @@index([difficulty])
  @@index([tags])
  @@map("questions")
}

model QuestionBank {
  id          String     @id @default(uuid())
  name        String
  description String?
  category    String?    @db.VarChar(100)
  createdBy   String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  questions   Question[]

  @@map("question_banks")
}

model ExamResult {
  id               String          @id @default(uuid())
  userId           String
  examId           String
  licenseKeyId     String?
  status           ResultStatus    @default(in_progress)
  totalScore       Int?
  maxScore         Int?
  percentage       Decimal?        @db.Decimal(5, 2)
  timeSpent        Int?
  startedAt        DateTime        @default(now())
  submittedAt      DateTime?
  gradedAt         DateTime?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  extractedWords   String[]        @default([])
  learningInsights Json?
  aiAnalysis       Json?
  aiAnalyzedAt     DateTime?
  exam             Exam            @relation(fields: [examId], references: [id])
  licenseKey       LicenseKey?     @relation(fields: [licenseKeyId], references: [id])
  user             User            @relation(fields: [userId], references: [id])
  sectionResults   SectionResult[]

  @@index([userId])
  @@index([examId])
  @@index([status])
  @@index([startedAt])
  @@map("exam_results")
}

model SectionResult {
  id              String           @id @default(uuid())
  examResultId    String
  sectionId       String
  correctCount    Int              @default(0)
  incorrectCount  Int              @default(0)
  unansweredCount Int              @default(0)
  score           Int?
  maxScore        Int?
  timeSpent       Int?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  questionResults QuestionResult[]
  examResult      ExamResult       @relation(fields: [examResultId], references: [id], onDelete: Cascade)
  section         Section          @relation(fields: [sectionId], references: [id])

  @@index([examResultId])
  @@index([sectionId])
  @@map("section_results")
}

model QuestionResult {
  id              String        @id @default(uuid())
  sectionResultId String
  questionId      String
  userAnswer      String?
  isCorrect       Boolean?
  pointsEarned    Int?
  pointsPossible  Int?
  timeSpent       Int?
  answeredAt      DateTime?
  aiExplanation   String?
  aiGeneratedAt   DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  question        Question      @relation(fields: [questionId], references: [id])
  sectionResult   SectionResult @relation(fields: [sectionResultId], references: [id], onDelete: Cascade)

  @@index([sectionResultId])
  @@index([questionId])
  @@index([isCorrect])
  @@index([answeredAt])
  @@map("question_results")
}

model UserExamSession {
  id                    String             @id @default(uuid())
  userId                String
  examId                String
  examResultId          String?
  currentSectionId      String?
  currentQuestionNumber Int?
  answers               Json               @default("{}")
  startTime             DateTime           @default(now())
  lastActivityAt        DateTime           @default(now()) @updatedAt
  expiresAt             DateTime?
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
  exam                  Exam               @relation(fields: [examId], references: [id], onDelete: Cascade)
  user                  User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  adaptiveQuestions     AdaptiveQuestion[]

  @@index([userId])
  @@index([examId])
  @@index([expiresAt])
  @@map("user_exam_sessions")
}

model AdaptiveQuestion {
  id              String           @id @default(uuid())
  sessionId       String
  questionId      String
  difficulty      Difficulty
  order           Int
  answeredAt      DateTime?
  isCorrect       Boolean?
  selectedAt      DateTime          @default(now())
  session         UserExamSession  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  question        Question         @relation(fields: [questionId], references: [id])
  exam            Exam             @relation(fields: [examId], references: [id], onDelete: Cascade)
  examId          String

  @@index([sessionId])
  @@index([questionId])
  @@index([examId])
  @@index([sessionId, order])
  @@map("adaptive_questions")
}

model LicenseKey {
  id          String            @id @default(uuid())
  userId      String?
  key         String            @unique
  keyType     KeyType
  examIds     String[]
  usageLimit  Int?
  usageCount  Int               @default(0)
  validFrom   DateTime          @default(now())
  validUntil  DateTime?
  isActive    Boolean           @default(true)
  issuedBy    String?
  issuedAt    DateTime          @default(now())
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  batchId     String?
  examResults ExamResult[]
  usageLogs   KeyUsageLog[]
  issuer      User?             @relation("IssuedBy", fields: [issuedBy], references: [id])
  user        User?             @relation(fields: [userId], references: [id])
  batch       LicenseKeyBatch?  @relation(fields: [batchId], references: [id])

  @@index([key])
  @@index([userId])
  @@index([keyType])
  @@index([validUntil])
  @@index([batchId])
  @@map("license_keys")
}

model LicenseKeyBatch {
  id          String        @id @default(uuid())
  name        String
  description String?
  keyType     KeyType
  count       Int
  examIds     String[]
  usageLimit  Int?
  validUntil  DateTime?
  createdBy   String
  createdAt   DateTime      @default(now())
  keys        LicenseKey[]
  issuer      User          @relation("BatchIssuer", fields: [createdBy], references: [id])

  @@index([createdBy])
  @@index([createdAt])
  @@index([validUntil])
  @@index([keyType])
  @@map("license_key_batches")
}

model KeyUsageLog {
  id           String     @id @default(uuid())
  licenseKeyId String
  userId       String?
  examId       String?
  examResultId String?
  action       String     @db.VarChar(50)
  status       LogStatus
  ipAddress    String?    @db.VarChar(45)
  userAgent    String?    @db.VarChar(500)
  createdAt    DateTime   @default(now())
  licenseKey   LicenseKey @relation(fields: [licenseKeyId], references: [id])
  user         User?      @relation(fields: [userId], references: [id])

  @@index([licenseKeyId])
  @@index([userId])
  @@index([createdAt])
  @@index([action])
  @@map("key_usage_logs")
}

model WordBook {
  id                 String      @id @default(uuid())
  userId             String
  word               String
  meaning            String
  example            String?
  difficulty         Difficulty?
  source             String?     @db.VarChar(100)
  sourceId           String?
  masteryLevel       Int         @default(0)
  reviewCount        Int         @default(0)
  lastReviewedAt     DateTime?
  nextReviewAt       DateTime?
  tags               String[]
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt
  extractedAt        DateTime?
  sourceExamResultId String?
  user               User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([word])
  @@index([nextReviewAt])
  @@index([tags])
  @@index([sourceExamResultId])
  @@map("word_books")
}

model AuditLog {
  id         String   @id @default(uuid())
  userId     String?
  action     String   @db.VarChar(100)
  entityType String   @db.VarChar(50)
  entityId   String?
  changes    Json?
  ipAddress  String?  @db.VarChar(45)
  userAgent  String?  @db.VarChar(500)
  createdAt  DateTime @default(now())
  user       User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

model UserGoal {
  id           String     @id @default(uuid())
  userId       String
  goalType     GoalType
  targetValue  Int
  currentValue Int        @default(0)
  deadline     DateTime
  status       GoalStatus @default(active)
  milestones   Json?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([deadline])
  @@map("user_goals")
}

model LearningPattern {
  id            String   @id @default(uuid())
  userId        String
  date          DateTime @default(now())
  hour          Int
  dayOfWeek     Int
  sessionLength Int
  score         Float?
  focusLevel    Float?
  efficiency    Float?
  examResultId  String?
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, date])
  @@index([hour])
  @@index([dayOfWeek])
  @@map("learning_patterns")
}

model LearningCycle {
  id           String    @id @default(uuid())
  userId       String
  cycleType    String
  stage        String    @default("identify")
  startDate    DateTime  @default(now())
  endDate      DateTime?
  targetWords  String[]  @default([])
  targetExams  String[]  @default([])
  improvement  Float?
  wordsLearned Int       @default(0)
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([stage])
  @@map("learning_cycles")
}

model ExamTemplate {
  id              String   @id @default(uuid())
  name            String
  description     String?
  structure       Json
  questionPoolIds String[] @default([])
  createdBy       String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  creator         User     @relation(fields: [createdBy], references: [id], onDelete: Cascade)
  exams           Exam[]   @relation("TemplateBased")

  @@index([createdBy])
  @@index([createdAt])
  @@map("exam_templates")
}

model QuestionPool {
  id          String      @id @default(uuid())
  name        String
  description String?
  tags        String[]    @default([])
  difficulty  Difficulty?
  questionIds String[]    @default([])
  createdBy   String
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  creator     User        @relation(fields: [createdBy], references: [id], onDelete: Cascade)

  @@index([createdBy])
  @@index([tags])
  @@index([difficulty])
  @@map("question_pools")
}

model SiteSettings {
  id              String   @id @default(uuid())
  companyName     String   @default("Exam Platform")
  logoUrl         String?  @db.VarChar(500)
  faviconUrl      String?  @db.VarChar(500)
  primaryColor    String?  @db.VarChar(7)
  secondaryColor  String?  @db.VarChar(7)
  accentColor     String?  @db.VarChar(7)
  colorScheme     Json?
  aboutCompany    String?
  aboutTeam       String?
  contactInfo     Json?
  serviceInfo     String?
  isActive        Boolean  @default(true)
  updatedBy       String?
  updatedAt       DateTime @updatedAt
  createdAt       DateTime @default(now())
  companyStats    Json?
  teamMembers     Json?
  serviceFeatures Json?
  serviceBenefits Json?
  serviceProcess  Json?
  company_values  Json?
  team_culture    Json?
  // 언어별 동적 콘텐츠 (JSON 형식)
  // homeContent: { ko: { hero: { title, subtitle }, features: [...] }, en: {...}, ja: {...} }
  homeContent     Json?    // 메인 페이지 콘텐츠 (언어별)
  // aboutContent: { ko: { team: { hero: {...} }, company: {...}, service: {...}, contact: {...} }, en: {...}, ja: {...} }
  aboutContent    Json?    // About 페이지 콘텐츠 (언어별)
  updater         User?    @relation("SiteSettingsUpdater", fields: [updatedBy], references: [id])

  @@index([isActive])
  @@map("site_settings")
}

enum UserRole {
  user
  admin
  partner
}

enum ExamType {
  mock
  practice
  official
}

enum Difficulty {
  easy
  medium
  hard
}

enum QuestionType {
  multiple_choice
  fill_blank
  essay
}

// 시험 카테고리 모델 (대분류)
model Category {
  id          String        @id @default(uuid())
  name        String        @db.VarChar(100)
  description String?
  icon        String?       @db.VarChar(50) // 아이콘 이름 또는 이모지
  order       Int           @default(0) // 정렬 순서
  isActive    Boolean       @default(true)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  subcategories Subcategory[]
  exams       Exam[]

  @@index([isActive])
  @@index([order])
  @@map("categories")
}

// 시험 서브카테고리 모델 (중분류)
model Subcategory {
  id          String        @id @default(uuid())
  categoryId  String
  name        String        @db.VarChar(100)
  description String?
  icon        String?       @db.VarChar(50)
  order       Int           @default(0)
  isActive    Boolean       @default(true)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  category    Category      @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  exams       Exam[]

  @@index([categoryId])
  @@index([isActive])
  @@index([order])
  @@map("subcategories")
}

enum ResultStatus {
  in_progress
  completed
  abandoned
  graded
}

enum KeyType {
  ACCESS_KEY
  TEST_KEY
  ADMIN_KEY
}

enum LogStatus {
  success
  failed
  rejected
}

enum GoalType {
  score_target
  weakness_recovery
  exam_count
  word_count
}

enum GoalStatus {
  active
  achieved
  failed
  paused
}
